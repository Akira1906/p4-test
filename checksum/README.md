# Introduction

checksum-ipv4-with-options.p4 is a small P4_16 program using the
latest v1model.p4 as of 2017-Oct-03, with correct syntax for checking
the received IPv4 header checksum, and updating the outgoing IPv4
header checksum.

The test cases given in this repository demonstrate that the outgoing
IPv4 header checksums are correct (at least for the couple of test
cases included).

Note: I do not know how to use the result of checking the received
IPv4 header checksum to drop, or otherwise treat different, received
IPv4 packets with an incorrect IPv4 header checksum.

As of 2018-Sep-20, the latest version of p4c's v1model.p4 include file
defines these fields in the `standard_metadata_t` struct type:

```
    bit<1>  checksum_error;
    error parser_error;
```

The latest version of `simple_switch` as of that date will execute
this compiled program, and can execute the code in the
`veirfyChecksum` control block and if you have enabled logging with
`--log-console` or `--log-file`, it will show log messages after
parsing indicating whether the received IPv4 header checksum was
correct or wrong, but it does not modify the `checksum_error` nor the
`parser_error` field as a result, nor any other fields.

The PSA v1.0 specification's InternetChecksum extern API is quite
different from v1model.p4, and does specify and include an example
P4_16 program showing how to detect and handle differently received
packets that have a bad checksum.  It is not yet implemented in the
open source P4 tools, though.


# Compiling

See README-using-bmv2.txt for some things that are common across
different P4 programs executed using bmv2.

To compile the P4_16 version of the code:

    p4c-bm2-ss checksum-ipv4-with-options.p4 -o checksum-ipv4-with-options.json

This program currently only compiles without errors using a version of
p4c after this 2017-Oct-03 commit:

    https://github.com/p4lang/p4c/commit/52e273d402cc4e18eb9a6db6c2b52d4bbc89a91b

I have checked in a file checksum-ipv4-with-options.json generated
with the p4c-bm2-ss command above, using a version of p4c-bm2-ss
compiled from the p4c repository, the latest master version as of
2017-Oct-30.

# Running

To run the behavioral model with 1 port numbered 0:

    sudo simple_switch --log-console -i 0@veth2 checksum-ipv4-with-options.json


No table entries need to be added for the default action 'foo' to be
run on all packets.


----------------------------------------------------------------------
scapy session for sending packets
----------------------------------------------------------------------
We must run scapy as root for it to have permission to send packets on
veth interfaces.

I found a working example of using Scapy to generate IPv4 headers with
IP options here: http://allievi.sssup.it/techblog/archives/631

    sudo scapy

    pkt1=Ether() / IP(dst='10.1.0.1') / TCP(sport=5793, dport=80)
    pkt2=Ether() / IP(dst='10.2.3.4', options=IPOption('\x83\x03\x10')) / TCP(sport=5501, dport=80)

    # Send packet at layer2, specifying interface
    sendp(pkt1, iface="veth2")
    sendp(pkt2, iface="veth2")

The file `packets-in-port0.pcap` in this directory contains a capture
of the input packets generated by the above Scapy function calls, as
sent to simple_switch.

The file `packets-out-port0.pcap` contains a capture of the output
packets produced by the checksum-ipv4-with-options.p4 program, when
given the above packets as input.

    % cp packets-in-port0.pcap 0_in.pcap

    # This command will read the pcap file 0_in.pcap for packets to
    # send into port 0 of simple_switch, and write output packets
    # transmitted on port 0 to file 0_out.pcap.
    
    % simple_switch -i 0@0 --use-files 0 checksum-ipv4-with-options.json

    [ Use Ctrl-C to kill simple_switch process after a second or two
      of inactivity ]

    % ls -l 0_out.pcap
    -rw-r--r-- 1 jafinger jafinger 168 Sep  5 02:31 0_out.pcap

    # Use editcap to change the link type of the pcap file from 'None'
    # to Ethernet, and the snaplen from 0 to 262144.  The resulting
    # output file 0_out_ether.pcap is more easily usable by programs
    # that read and process pcap files.
    
    % editcap -F pcap -T ether 0_out.pcap 0_out_ether.pcap

    # Use Scapy to verify that the packets out in 0_out_ether.pcap are
    # the same as those in packets-out-port0.pcap
    
    % scapy
    Welcome to Scapy (2.3.3)
    >>> p1=rdpcap('packets-out-port0.pcap')
    >>> p2=rdpcap('0_out_ether.pcap')
    >>> len(p1)
    2
    >>> len(p2)
    2
    >>> str(p1[0])==str(p2[0])
    True
    >>> str(p1[1])==str(p2[1])
    True

----------------------------------------
